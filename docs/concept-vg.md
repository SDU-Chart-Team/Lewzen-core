# 组件矢量图内概念分析

## 坐标系

|坐标系|说明|
|:-|:-|
|画布坐标系|画布的绝对坐标系|
|图形坐标系|以图形中心为原点的绝对坐标系|
|图形相对坐标系|以图形中心为原点，以图形矩形区域长宽为$[-1,1]$的相对坐标系|
|点坐标系|以一点$a$作为原点的绝对坐标系|
|点相对坐标系|以一点$a$作为原点，另一点$b$作为$(1,1)$的相对坐标系|
|向量坐标系|以一点$a$作为原点，$\overrightarrow{ab}$作为x轴的绝对坐标系|
|向量相对坐标系|以一点$a$作为原点，另一点$b$作为$(1,0)$的相对坐标系|

## 点

### 关键点（蓝色点、黄色点）

可由用户移动的点。根据关键点计算路径点。

点的颜色：设计图形时自拟。一般维持图形轮廓的为蓝色点，确定图形细节的为黄色点。蓝色点一般无活动域，黄色点存在活动域。

点的id和名称：用于区分各个点。

- 关键点的活动域

    用户对关键点的位置作出修改时，需要限制其活动范围。但由于关键点的相对性，只能使用点之间的相对限制。需要引入`活动域约束`，一种几何意义上的范围约束，来表示这种限制。

    首先需要确定活动域约束的相对坐标系，点坐标系或者向量坐标系；接下来根据其他点在该坐标系中的坐标、或者常量坐标$(x_i,y_i)$，计算活动域。

    每次动点作出改变时，计算其是否在活动域内。若不在，则根据运动方向计算一个边缘位置。

    - 活动域约束函数
    
        返回二维坐标，表示动点最终在活动域内的坐标。

        一些预设的活动域约束：

        |活动域约束|参数|说明|
        |:-:|:-|:-|
        |线段约束|坐标系、$(x_1,y_1)$、$(x_2,y_2)$|约束活动域为坐标系下的一条线段或直线|
        |矩形约束|坐标系、$(x_1,y_1)$、$(x_2,y_2)$|约束活动域为坐标系下的一个矩形|
        |封闭约束|坐标系、$(x_i,y_i)$、内/外|约束活动域为多个点组成的封闭图形的内或外|

- 关键点的主从关系

    当其他某些关键点$a,b,c,...$变化时，关键点$x$需要动态发生变化，以保持与前者间的状态。称$x$为从动关键点，变化的$a,b,c,...$称为主动点。称从动点根据主动点变化的规则为`主从约束`。

    主从约束指的是几何意义上的定值约束，它需要能根据主动点变化前后的位置重新计算出唯一的从动点的位置。
    
    主从关系是逐级传播的，因此可能存在环与冲突，这导致一个关键点集合内的约束可能是死约束。为了避免这种情况，认为已经变化的点不受主从约束影响。

    主从关系的传播导致一些从动点可能不满足其活动域。所以主从约束的必须支持反馈，即，根据从动点的位置逆运算得到主动点的位置。这个过程可能会在一个关系链上反复进行，甚至无限进行（无解）。认为次数超过10次无解，直接撤销修改。

    - 活动域约束函数

        返回两个二维坐标。第一个二维坐标表示从动点的合法位置，第二个二维坐标表示主动点的合法位置。若主动点当前坐标与返回得到的坐标不同，则反馈至上级，然后重新计算。

        一些预设的主从约束：

        |主从约束|参数|说明|
        |:-:|:-|:-|
        |向量约束|坐标系、主动点变化前后坐标|使主动点与从动点间的向量在某坐标系下不变|
        |三角约束|主动点变化前后坐标、支点|使主动点、从动点、支点构成的三角形相似|

- 点变更接口

    一个函数接口，输入该点新的坐标。然后这个接口会根据该关键点新的坐标，自适应图形。具体步骤包括活动域检查、从动点传递更新。

    返回真或假。真表示更新合法，且此时图像对象内部已完成更新；否则更新不合法，图形对象内部保持原状态。

### 路径点（蓝色叉）

由关键点生成的路径点，进而用于生成路径。

点的样式：若路径点和关键点重合，则只显示关键点。

点的id和名称：用于区分各个点。

- 路径点生成器函数

    返回一个二维坐标。输入坐标系、一些关键点的坐标，返回一个坐标。

    一些预设的生成器：

    |生成器|参数|说明|
    |:-:|:-|:-|
    |自身|关键点坐标|直接使用关键点坐标|
    |轴对称|坐标系、x轴/y轴、关键点坐标|返回一个与关键点坐标关于某轴对称的坐标|
    |中心对称|中心点坐标、关键点坐标|返回一个与关键点坐标关于某点中心对称的坐标|
    |多边形中心|多个关键点坐标|返回一个与多个关键点的中心的坐标|
    |$p$等分点|多个关键点坐标，权重|以权重作为力，返回平衡位置坐标|

## 矢量图

全部基于svg中的定义。

- 样式
    
    矢量图的线条粗细、颜色、区域填充、渐变、变换等。基于svg的style。

- 样式变更接口

    一个矢量图内的路径样式适用于所有路径。（若某路径样式固定，则不做修改）

- 产出

    svg的xml。

### 基本矢量图

基于svg，有'\<rect\>'、'\<circle\>'、'\<image\>'等。参数可引用关键点坐标计算。

### 路径矢量图

路径点按顺序连接形成路径，路径形成的封闭图形为矢量图。

- 路径连接方式

    基于svg中'\<path\>'的属性'd'，有：直线连接、弧连接、贝塞尔连接。

    详见：https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths


### 矢量图组合

一些基本矢量图形被组合到'\<g\>'内，作为矢量图形的组合。

### 预定义

一些svg中支持的预定义内容，被声明在'\<defs\>'内，可在样式中引用。